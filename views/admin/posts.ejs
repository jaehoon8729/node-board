<%- include('../partials/header', { title: '게시글 관리', activePage: 'admin' }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>게시글 관리</h2>
    <div>
        <a href="/board/write" class="btn btn-success me-2">
            <i class="bi bi-plus-circle"></i> 새 게시글
        </a>
        <a href="/admin" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 대시보드
        </a>
    </div>
</div>

<!-- 상태 필터 탭 -->
<div class="card mb-3">
    <div class="card-header">
        <ul class="nav nav-pills card-header-pills">
            <li class="nav-item">
                <a class="nav-link <%= currentStatus === 'all' ? 'active' : '' %>" 
                   href="/admin/posts?status=all">
                    전체 <span class="badge bg-secondary ms-1"><%= statusCounts.all %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link <%= currentStatus === 'published' ? 'active' : '' %>" 
                   href="/admin/posts?status=published">
                    발행됨 <span class="badge bg-success ms-1"><%= statusCounts.published %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link <%= currentStatus === 'scheduled' ? 'active' : '' %>" 
                   href="/admin/posts?status=scheduled">
                    예약중 <span class="badge bg-warning ms-1"><%= statusCounts.scheduled %></span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link <%= currentStatus === 'draft' ? 'active' : '' %>" 
                   href="/admin/posts?status=draft">
                    임시저장 <span class="badge bg-info ms-1"><%= statusCounts.draft %></span>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- 게시글 목록 -->
<div class="card">
    <div class="card-body p-0">
        <% if (posts.length === 0) { %>
            <div class="text-center py-5 text-muted">
                <i class="bi bi-file-earmark-text fs-1"></i>
                <p class="mt-3 mb-0">게시글이 없습니다.</p>
            </div>
        <% } else { %>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 8%">ID</th>
                            <th style="width: 35%">제목</th>
                            <th style="width: 12%">작성자</th>
                            <th style="width: 10%">상태</th>
                            <th style="width: 15%">예약시간</th>
                            <th style="width: 10%">조회수</th>
                            <th style="width: 10%">관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% posts.forEach(post => { %>
                            <tr>
                                <td><%= post.id %></td>
                                <td>
                                    <% if (post.status === 'published') { %>
                                        <a href="/board/<%= post.id %>" class="text-decoration-none">
                                            <%= post.title %>
                                        </a>
                                    <% } else { %>
                                        <%= post.title %>
                                    <% } %>
                                    
                                    <% if (post.file_original_name) { %>
                                        <% 
                                            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
                                            const fileExt = post.file_original_name.toLowerCase().substring(post.file_original_name.lastIndexOf('.'));
                                            const isImage = imageExtensions.includes(fileExt);
                                        %>
                                        <% if (isImage) { %>
                                            <i class="bi bi-image text-success ms-1" title="이미지 첨부"></i>
                                        <% } else { %>
                                            <i class="bi bi-paperclip text-primary ms-1" title="파일 첨부"></i>
                                        <% } %>
                                    <% } %>
                                </td>
                                <td><%= post.user.username %></td>
                                <td>
                                    <% if (post.status === 'published') { %>
                                        <span class="badge bg-success">발행됨</span>
                                    <% } else if (post.status === 'scheduled') { %>
                                        <span class="badge bg-warning">예약중</span>
                                    <% } else if (post.status === 'draft') { %>
                                        <span class="badge bg-info">임시저장</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (post.publish_at) { %>
                                        <small class="text-muted">
                                            <%= new Date(post.publish_at).toLocaleString() %>
                                        </small>
                                    <% } else if (post.status === 'published') { %>
                                        <small class="text-muted">
                                            <%= new Date(post.created_at).toLocaleString() %>
                                        </small>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (post.status === 'published') { %>
                                        <%= post.views %>
                                    <% } else { %>
                                        <span class="text-muted">-</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <% if (post.status === 'scheduled') { %>
                                            <!-- 예약 게시글 액션 -->
                                            <button type="button" class="btn btn-outline-success btn-sm" 
                                                    onclick="publishNow(<%= post.id %>)" title="즉시 발행">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                                    onclick="cancelSchedule(<%= post.id %>)" title="예약 취소">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        <% } else if (post.status === 'draft') { %>
                                            <!-- 임시저장 게시글 액션 -->
                                            <button type="button" class="btn btn-outline-success btn-sm" 
                                                    onclick="publishNow(<%= post.id %>)" title="즉시 발행">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <a href="/board/<%= post.id %>/edit" class="btn btn-outline-primary btn-sm" title="편집">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        <% } else { %>
                                            <!-- 발행된 게시글 액션 -->
                                            <a href="/board/<%= post.id %>" class="btn btn-outline-info btn-sm" title="보기">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="/board/<%= post.id %>/edit" class="btn btn-outline-primary btn-sm" title="편집">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                        <% } %>
                                        
                                        <!-- 삭제 버튼 (모든 상태 공통) -->
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="deletePost(<%= post.id %>)" title="삭제">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</div>

<!-- 페이지네이션 -->
<% if (totalPages > 1) { %>
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage - 1 %>&status=<%= currentStatus %>">
                    이전
                </a>
            </li>
            
            <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&status=<%= currentStatus %>">
                        <%= i %>
                    </a>
                </li>
            <% } %>
            
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage + 1 %>&status=<%= currentStatus %>">
                    다음
                </a>
            </li>
        </ul>
    </nav>
<% } %>

<!-- 액션 폼들 (숨김) -->
<form id="actionForm" method="POST" style="display: none;">
    <input type="hidden" name="action" id="actionType">
</form>

<script>
// 즉시 발행
function publishNow(postId) {
    if (confirm('게시글을 즉시 발행하시겠습니까?')) {
        const form = document.getElementById('actionForm');
        form.action = `/admin/posts/${postId}/action`;
        document.getElementById('actionType').value = 'publish_now';
        form.submit();
    }
}

// 예약 취소
function cancelSchedule(postId) {
    if (confirm('예약 발행을 취소하고 임시저장으로 변경하시겠습니까?')) {
        const form = document.getElementById('actionForm');
        form.action = `/admin/posts/${postId}/action`;
        document.getElementById('actionType').value = 'cancel_schedule';
        form.submit();
    }
}

// 게시글 삭제
function deletePost(postId) {
    if (confirm('정말로 이 게시글을 삭제하시겠습니까?\n삭제된 게시글은 복구할 수 없습니다.')) {
        const form = document.getElementById('actionForm');
        form.action = `/board/${postId}/delete`;
        form.submit();
    }
}
</script>

<%- include('../partials/footer') %>
