<%- include('../partials/header', { title: post.title, activePage: 'board' }) %>

<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
        <div class="card mb-4">
            <!-- ê²Œì‹œê¸€ ìƒíƒœ í‘œì‹œ (ê´€ë¦¬ìë§Œ) -->
            <% if (locals.user && locals.user.is_admin && post.status !== 'published') { %>
                <div class="alert alert-<%= post.status === 'scheduled' ? 'warning' : 'info' %> mb-0 rounded-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-<%= post.status === 'scheduled' ? 'clock' : 'file-earmark' %> me-2"></i>
                        <div>
                            <strong>
                                <% if (post.status === 'scheduled') { %>
                                    ğŸ“… ì˜ˆì•½ ê²Œì‹œê¸€ - <%= new Date(post.publish_at).toLocaleString() %>ì— ë°œí–‰ ì˜ˆì •
                                <% } else if (post.status === 'draft') { %>
                                    ğŸ’¾ ì„ì‹œì €ì¥ ê²Œì‹œê¸€ - ì•„ì§ ë°œí–‰ë˜ì§€ ì•ŠìŒ
                                <% } %>
                            </strong>
                            <br>
                            <small>ì´ ê²Œì‹œê¸€ì€ ê´€ë¦¬ìë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <div class="card-header bg-white">
                <h3 class="mb-0"><%= post.title %></h3>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between text-muted mb-3">
                    <div>
                        <i class="bi bi-person"></i> <%= post.custom_author || post.user.username %>
                    </div>
                    <div>
                        <span class="me-3">
                            <i class="bi bi-calendar"></i> 
                            <%= new Date(post.created_at).toISOString().replace('T', ' ').slice(0, 16) %>
                        </span>
                        <span>
                            <i class="bi bi-eye"></i> <%= post.views %>
                        </span>
                    </div>
                </div>
                
                <!-- ì²¨ë¶€íŒŒì¼ í‘œì‹œ -->
                <% if (post.file_original_name) { %>
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-paperclip me-2 text-primary"></i>
                                <span class="fw-medium"><%= post.file_original_name %></span>
                                <span class="text-muted ms-2">
                                    (<%= (post.file_size / (1024 * 1024)).toFixed(2) %>MB)
                                </span>
                            </div>
                            <a href="/board/download/<%= post.id %>" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                            </a>
                        </div>
                        
                        <!-- ì´ë¯¸ì§€ íŒŒì¼ì¸ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° -->
                        <% 
                            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
                            const fileExt = post.file_original_name.toLowerCase().substring(post.file_original_name.lastIndexOf('.'));
                            const isImage = imageExtensions.includes(fileExt);
                        %>
                        <% if (isImage) { %>
                            <div class="text-center mt-3">
                                <img src="/uploads/<%= post.file_name %>" 
                                     alt="<%= post.file_original_name %>" 
                                     class="img-fluid rounded shadow-sm"
                                     style="max-height: 500px; cursor: pointer;"
                                     onclick="openImageModal(this.src, '<%= post.file_original_name %>')">
                            </div>
                        <% } %>
                    </div>
                <% } %>
                
                <div class="post-content" style="min-height: 200px; white-space: pre-wrap;"><%=
                    post.content
                %></div>
            </div>
            <div class="card-footer bg-white">
                <div class="d-flex justify-content-between">
                    <a href="/board" class="btn btn-secondary btn-sm">
                        <i class="bi bi-list"></i> ëª©ë¡
                    </a>
                    
                    <% if (canEdit) { %>
                        <div>
                            <a href="/board/<%= post.id %>/edit" class="btn btn-primary btn-sm">
                                <i class="bi bi-pencil"></i> ìˆ˜ì •
                            </a>
                            <form action="/board/<%= post.id %>/delete" method="POST" 
                                  class="d-inline" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> ì‚­ì œ
                                </button>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ëŒ“ê¸€ (<span id="comment-count"><%= post.comments.length %></span>)</h5>
            </div>
            <div class="card-body">
                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <% if (locals.user) { %>
                    <div class="mb-4">
                        <form id="comment-form">
                            <!-- ê´€ë¦¬ìì¸ ê²½ìš° ì‘ì„±ì ì„ íƒ -->
                            <% if (locals.user.is_admin) { %>
                                <div class="mb-2">
                                    <label for="comment-author" class="form-label">ì‘ì„±ì ì„ íƒ:</label>
                                    <select class="form-select" id="comment-author" name="custom_author">
                                        <option value="">ë³¸ì¸ ê³„ì • (<%= locals.user.username %>)</option>
                                        <option value="" disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                        <!-- ì‚¬ìš©ì ëª©ë¡ì€ JavaScriptë¡œ ë¡œë“œ -->
                                    </select>
                                </div>
                            <% } %>
                            
                            <div class="mb-2">
                                <textarea class="form-control" id="comment-content" rows="3" 
                                          placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-chat-dots"></i> ëŒ“ê¸€ ì‘ì„±
                                </button>
                            </div>
                        </form>
                    </div>
                <% } else { %>
                    <div class="alert alert-info mb-4">
                        ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/auth/login">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </div>
                <% } %>
                
                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div id="comment-list">
                    <% if (post.comments.length === 0) { %>
                        <p class="text-muted text-center" id="no-comments">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                    <% } else { %>
                        <% post.comments.forEach(comment => { %>
                            <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="<%= comment.id %>">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong><%= comment.custom_author || comment.user.username %></strong>
                                        <small class="text-muted ms-2">
                                            <%= new Date(comment.created_at).toLocaleString() %>
                                        </small>
                                    </div>
                                    <% if (locals.user && (locals.user.id === comment.user_id || locals.user.is_admin)) { %>
                                        <div>
                                            <button class="btn btn-sm btn-link edit-comment" 
                                                    data-comment-id="<%= comment.id %>"
                                                    data-custom-author="<%= comment.custom_author || '' %>">ìˆ˜ì •</button>
                                            <button class="btn btn-sm btn-link text-danger delete-comment" 
                                                    data-comment-id="<%= comment.id %>">ì‚­ì œ</button>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="comment-content mt-2"><%= comment.content %></div>
                                <div class="comment-edit-form d-none">
                                    <% if (locals.user.is_admin) { %>
                                        <div class="mb-2">
                                            <label class="form-label">ì‘ì„±ì ì„ íƒ:</label>
                                            <select class="form-select edit-author-select" name="custom_author">
                                                <option value="">ë³¸ì¸ ê³„ì • (<%= locals.user.username %>)</option>
                                                <option value="" disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                                                <!-- ì‚¬ìš©ì ëª©ë¡ì€ JavaScriptë¡œ ë¡œë“œ -->
                                            </select>
                                        </div>
                                    <% } %>
                                    <textarea class="form-control mb-2" rows="3"><%= comment.content %></textarea>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-secondary cancel-edit">ì·¨ì†Œ</button>
                                        <button class="btn btn-sm btn-primary save-edit" 
                                                data-comment-id="<%= comment.id %>">ì €ì¥</button>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">ì´ë¯¸ì§€ í™•ëŒ€ë³´ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid rounded">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                <a id="modalDownloadBtn" href="#" class="btn btn-primary">
                    <i class="bi bi-download"></i> ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const postId = <%= post.id %>;
    const isLoggedIn = <%= locals.user ? 'true' : 'false' %>;
    const currentUserId = <%= locals.user ? locals.user.id : 'null' %>;
    const isAdmin = <%= locals.user && locals.user.is_admin ? 'true' : 'false' %>;
    
    let users = []; // ê´€ë¦¬ììš© ì‚¬ìš©ì ëª©ë¡
    
    // ê´€ë¦¬ìì¸ ê²½ìš° ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
    if (isAdmin) {
        loadUsers();
    }
    
    async function loadUsers() {
        try {
            const response = await fetch('/api/comments/users');
            const data = await response.json();
            
            if (data.success) {
                users = data.users;
                populateUserSelects();
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }
    
    function populateUserSelects() {
        const selects = document.querySelectorAll('#comment-author, .edit-author-select');
        selects.forEach(select => {
            // ê¸°ì¡´ ì‚¬ìš©ì ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ì™€ êµ¬ë¶„ì„ ì€ ìœ ì§€)
            while (select.children.length > 2) {
                select.removeChild(select.lastChild);
            }
            
            // ì‚¬ìš©ì ëª©ë¡ ì¶”ê°€
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                select.appendChild(option);
            });
        });
    }
    
    // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openImageModal(imageSrc, imageName) {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('modalImage').alt = imageName;
        document.getElementById('imageModalLabel').textContent = imageName;
        document.getElementById('modalDownloadBtn').href = `/board/download/${postId}`;
        modal.show();
    }
    
    // ëŒ“ê¸€ ì‘ì„±
    if (isLoggedIn) {
        document.getElementById('comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('comment-content').value;
            const requestData = { post_id: postId, content };
            
            // ê´€ë¦¬ìì¸ ê²½ìš° ì‘ì„±ì ì„ íƒ ê°’ ì¶”ê°€
            if (isAdmin) {
                const customAuthor = document.getElementById('comment-author').value;
                if (customAuthor) {
                    requestData.custom_author = customAuthor;
                }
            }
            
            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ëŒ“ê¸€ ëª©ë¡ì— ì¶”ê°€
                    const commentList = document.getElementById('comment-list');
                    const noComments = document.getElementById('no-comments');
                    if (noComments) noComments.remove();
                    
                    const commentHtml = createCommentHtml(data.comment);
                    commentList.insertAdjacentHTML('beforeend', commentHtml);
                    
                    // ìƒˆë¡œ ì¶”ê°€ëœ ëŒ“ê¸€ì˜ ìˆ˜ì • í¼ì—ë„ ì‚¬ìš©ì ëª©ë¡ ì¶”ê°€
                    if (isAdmin) {
                        populateUserSelects();
                    }
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('comment-content').value = '';
                    if (isAdmin) {
                        document.getElementById('comment-author').value = '';
                    }
                    
                    // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
                    const countEl = document.getElementById('comment-count');
                    countEl.textContent = parseInt(countEl.textContent) + 1;
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    }
    
    // ëŒ“ê¸€ HTML ìƒì„± í•¨ìˆ˜
    function createCommentHtml(comment) {
        const date = new Date(comment.created_at).toLocaleString();
        const canEdit = currentUserId === comment.user_id || isAdmin;
        const authorName = comment.custom_author || comment.user.username;
        
        let editAuthorSelect = '';
        if (isAdmin) {
            editAuthorSelect = `
                <div class="mb-2">
                    <label class="form-label">ì‘ì„±ì ì„ íƒ:</label>
                    <select class="form-select edit-author-select" name="custom_author">
                        <option value="">ë³¸ì¸ ê³„ì • (${comment.user.username})</option>
                        <option value="" disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
                        <!-- ì‚¬ìš©ì ëª©ë¡ì€ JavaScriptë¡œ ë¡œë“œ -->
                    </select>
                </div>
            `;
        }
        
        return `
            <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="${comment.id}">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${authorName}</strong>
                        <small class="text-muted ms-2">${date}</small>
                    </div>
                    ${canEdit ? `
                        <div>
                            <button class="btn btn-sm btn-link edit-comment" 
                                    data-comment-id="${comment.id}"
                                    data-custom-author="${comment.custom_author || ''}">ìˆ˜ì •</button>
                            <button class="btn btn-sm btn-link text-danger delete-comment" 
                                    data-comment-id="${comment.id}">ì‚­ì œ</button>
                        </div>
                    ` : ''}
                </div>
                <div class="comment-content mt-2">${comment.content}</div>
                <div class="comment-edit-form d-none">
                    ${editAuthorSelect}
                    <textarea class="form-control mb-2" rows="3">${comment.content}</textarea>
                    <div class="text-end">
                        <button class="btn btn-sm btn-secondary cancel-edit">ì·¨ì†Œ</button>
                        <button class="btn btn-sm btn-primary save-edit" 
                                data-comment-id="${comment.id}">ì €ì¥</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ì´ë²¤íŠ¸ ìœ„ì„ì„ ì‚¬ìš©í•œ ëŒ“ê¸€ ìˆ˜ì •/ì‚­ì œ
    document.getElementById('comment-list').addEventListener('click', async (e) => {
        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­
        if (e.target.classList.contains('edit-comment')) {
            const commentItem = e.target.closest('.comment-item');
            const customAuthor = e.target.dataset.customAuthor;
            
            commentItem.querySelector('.comment-content').classList.add('d-none');
            commentItem.querySelector('.comment-edit-form').classList.remove('d-none');
            
            // ê´€ë¦¬ìì¸ ê²½ìš° ì‘ì„±ì ì„ íƒ ê°’ ì„¤ì •
            if (isAdmin) {
                const authorSelect = commentItem.querySelector('.edit-author-select');
                if (authorSelect) {
                    authorSelect.value = customAuthor || '';
                }
            }
        }
        
        // ìˆ˜ì • ì·¨ì†Œ
        if (e.target.classList.contains('cancel-edit')) {
            const commentItem = e.target.closest('.comment-item');
            commentItem.querySelector('.comment-content').classList.remove('d-none');
            commentItem.querySelector('.comment-edit-form').classList.add('d-none');
        }
        
        // ìˆ˜ì • ì €ì¥
        if (e.target.classList.contains('save-edit')) {
            const commentId = e.target.dataset.commentId;
            const commentItem = e.target.closest('.comment-item');
            const content = commentItem.querySelector('textarea').value;
            
            const requestData = { content };
            
            // ê´€ë¦¬ìì¸ ê²½ìš° ì‘ì„±ì ì„ íƒ ê°’ ì¶”ê°€
            if (isAdmin) {
                const authorSelect = commentItem.querySelector('.edit-author-select');
                if (authorSelect) {
                    requestData.custom_author = authorSelect.value;
                }
            }
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ëŒ“ê¸€ ë‚´ìš© ì—…ë°ì´íŠ¸
                    commentItem.querySelector('.comment-content').textContent = content;
                    
                    // ì‘ì„±ìëª… ì—…ë°ì´íŠ¸
                    const authorElement = commentItem.querySelector('strong');
                    const newAuthor = requestData.custom_author || data.comment.user?.username || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    authorElement.textContent = newAuthor;
                    
                    // ìˆ˜ì • ë²„íŠ¼ì˜ ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
                    const editBtn = commentItem.querySelector('.edit-comment');
                    if (editBtn) {
                        editBtn.dataset.customAuthor = requestData.custom_author || '';
                    }
                    
                    commentItem.querySelector('.comment-content').classList.remove('d-none');
                    commentItem.querySelector('.comment-edit-form').classList.add('d-none');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‚­ì œ
        if (e.target.classList.contains('delete-comment')) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const commentId = e.target.dataset.commentId;
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    e.target.closest('.comment-item').remove();
                    
                    // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
                    const countEl = document.getElementById('comment-count');
                    countEl.textContent = parseInt(countEl.textContent) - 1;
                    
                    // ëŒ“ê¸€ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                    const commentList = document.getElementById('comment-list');
                    if (commentList.children.length === 0) {
                        commentList.innerHTML = '<p class="text-muted text-center" id="no-comments">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>';
                    }
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    });
</script>

<%- include('../partials/footer') %>
