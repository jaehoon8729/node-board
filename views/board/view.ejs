<%- include('../partials/header', { title: post.title, activePage: 'board' }) %>

<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Í≤åÏãúÍ∏Ä ÎÇ¥Ïö© -->
        <div class="card mb-4">
            <!-- Í≤åÏãúÍ∏Ä ÏÉÅÌÉú ÌëúÏãú (Í¥ÄÎ¶¨ÏûêÎßå) -->
            <% if (locals.user && locals.user.is_admin && post.status !== 'published') { %>
                <div class="alert alert-<%= post.status === 'scheduled' ? 'warning' : 'info' %> mb-0 rounded-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-<%= post.status === 'scheduled' ? 'clock' : 'file-earmark' %> me-2"></i>
                        <div>
                            <strong>
                                <% if (post.status === 'scheduled') { %>
                                    üìÖ ÏòàÏïΩ Í≤åÏãúÍ∏Ä - <%= new Date(post.publish_at).toLocaleString() %>Ïóê Î∞úÌñâ ÏòàÏ†ï
                                <% } else if (post.status === 'draft') { %>
                                    üíæ ÏûÑÏãúÏ†ÄÏû• Í≤åÏãúÍ∏Ä - ÏïÑÏßÅ Î∞úÌñâÎêòÏßÄ ÏïäÏùå
                                <% } %>
                            </strong>
                            <br>
                            <small>Ïù¥ Í≤åÏãúÍ∏ÄÏùÄ Í¥ÄÎ¶¨ÏûêÎßå Î≥º Ïàò ÏûàÏäµÎãàÎã§.</small>
                        </div>
                    </div>
                </div>
            <% } %>
            
            <div class="card-header bg-white">
                <h3 class="mb-0"><%= post.title %></h3>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between text-muted mb-3">
                    <div>
                        <i class="bi bi-person"></i> <%= post.custom_author || post.user.username %>
                    </div>
                    <div>
                        <span class="me-3">
                            <i class="bi bi-calendar"></i> 
                            <%= new Date(post.created_at).toISOString().replace('T', ' ').slice(0, 16) %>
                        </span>
                        <span>
                            <i class="bi bi-eye"></i> <%= post.views %>
                        </span>
                    </div>
                </div>
                
                <!-- Ï≤®Î∂ÄÌååÏùº ÌëúÏãú -->
                <% if (post.file_original_name) { %>
                    <div class="mb-3 p-3 bg-light rounded">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-paperclip me-2 text-primary"></i>
                                <span class="fw-medium"><%= post.file_original_name %></span>
                                <span class="text-muted ms-2">
                                    (<%= (post.file_size / (1024 * 1024)).toFixed(2) %>MB)
                                </span>
                            </div>
                            <a href="/board/download/<%= post.id %>" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-download"></i> Îã§Ïö¥Î°úÎìú
                            </a>
                        </div>
                        
                        <!-- Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù∏ Í≤ΩÏö∞ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                        <% 
                            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
                            const fileExt = post.file_original_name.toLowerCase().substring(post.file_original_name.lastIndexOf('.'));
                            const isImage = imageExtensions.includes(fileExt);
                        %>
                        <% if (isImage) { %>
                            <div class="text-center mt-3">
                                <img src="/uploads/<%= post.file_name %>" 
                                     alt="<%= post.file_original_name %>" 
                                     class="img-fluid rounded shadow-sm"
                                     style="max-height: 500px; cursor: pointer;"
                                     onclick="openImageModal(this.src, '<%= post.file_original_name %>')">
                            </div>
                        <% } %>
                    </div>
                <% } %>
                
                <div class="post-content" style="min-height: 200px; white-space: pre-wrap;"><%=
                    post.content
                %></div>
            </div>
            <div class="card-footer bg-white">
                <div class="d-flex justify-content-between">
                    <a href="/board" class="btn btn-secondary btn-sm">
                        <i class="bi bi-list"></i> Î™©Î°ù
                    </a>
                    
                    <% if (canEdit) { %>
                        <div>
                            <a href="/board/<%= post.id %>/edit" class="btn btn-primary btn-sm">
                                <i class="bi bi-pencil"></i> ÏàòÏ†ï
                            </a>
                            <form action="/board/<%= post.id %>/delete" method="POST" 
                                  class="d-inline" onsubmit="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash"></i> ÏÇ≠Ï†ú
                                </button>
                            </form>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
        
        <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">ÎåìÍ∏Ä (<span id="comment-count"><%= post.comments.length %></span>)</h5>
            </div>
            <div class="card-body">
                <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
                <% if (locals.user) { %>
                    <div class="mb-4">
                        <form id="comment-form">
                            <!-- Í¥ÄÎ¶¨ÏûêÏù∏ Í≤ΩÏö∞ ÏûëÏÑ±Ïûê ÏÑ†ÌÉù -->
                            <% if (locals.user.is_admin) { %>
                                <div class="mb-2">
                                    <label for="comment-author" class="form-label">ÏûëÏÑ±Ïûê ÏÑ†ÌÉù:</label>
                                    <select class="form-select" id="comment-author" name="custom_author">
                                        <option value="">Î≥∏Ïù∏ Í≥ÑÏ†ï (<%= locals.user.username %>)</option>
                                        <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                        <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÄ JavaScriptÎ°ú Î°úÎìú -->
                                    </select>
                                </div>
                            <% } %>
                            
                            <div class="mb-2">
                                <textarea class="form-control" id="comment-content" rows="3" 
                                          placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." required></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-chat-dots"></i> ÎåìÍ∏Ä ÏûëÏÑ±
                                </button>
                            </div>
                        </form>
                    </div>
                <% } else { %>
                    <div class="alert alert-info mb-4">
                        ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ <a href="/auth/login">Î°úÍ∑∏Ïù∏</a>Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.
                    </div>
                <% } %>
                
                <!-- ÎåìÍ∏Ä Î™©Î°ù -->
                <div id="comment-list">
                    <% if (post.comments.length === 0) { %>
                        <p class="text-muted text-center" id="no-comments">Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>
                    <% } else { %>
                        <% post.comments.forEach(comment => { %>
                            <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="<%= comment.id %>">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong><%= comment.custom_author || comment.user.username %></strong>
                                        <small class="text-muted ms-2">
                                            <%= new Date(comment.created_at).toLocaleString() %>
                                        </small>
                                    </div>
                                    <% if (locals.user && (locals.user.id === comment.user_id || locals.user.is_admin)) { %>
                                        <div>
                                            <button class="btn btn-sm btn-link edit-comment" 
                                                    data-comment-id="<%= comment.id %>"
                                                    data-custom-author="<%= comment.custom_author || '' %>">ÏàòÏ†ï</button>
                                            <button class="btn btn-sm btn-link text-danger delete-comment" 
                                                    data-comment-id="<%= comment.id %>">ÏÇ≠Ï†ú</button>
                                        </div>
                                    <% } %>
                                </div>
                                <div class="comment-content mt-2"><%= comment.content %></div>
                                <div class="comment-edit-form d-none">
                                    <% if (locals.user.is_admin) { %>
                                        <div class="mb-2">
                                            <label class="form-label">ÏûëÏÑ±Ïûê ÏÑ†ÌÉù:</label>
                                            <select class="form-select edit-author-select" name="custom_author">
                                                <option value="">Î≥∏Ïù∏ Í≥ÑÏ†ï (<%= locals.user.username %>)</option>
                                                <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                                <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÄ JavaScriptÎ°ú Î°úÎìú -->
                                            </select>
                                        </div>
                                    <% } %>
                                    <textarea class="form-control mb-2" rows="3"><%= comment.content %></textarea>
                                    <div class="text-end">
                                        <button class="btn btn-sm btn-secondary cancel-edit">Ï∑®ÏÜå</button>
                                        <button class="btn btn-sm btn-primary save-edit" 
                                                data-comment-id="<%= comment.id %>">Ï†ÄÏû•</button>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄÎ≥¥Í∏∞ Î™®Îã¨ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Ïù¥ÎØ∏ÏßÄ ÌôïÎåÄÎ≥¥Í∏∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid rounded">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
                <a id="modalDownloadBtn" href="#" class="btn btn-primary">
                    <i class="bi bi-download"></i> Îã§Ïö¥Î°úÎìú
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const postId = <%= post.id %>;
    const isLoggedIn = <%= locals.user ? 'true' : 'false' %>;
    const currentUserId = <%= locals.user ? locals.user.id : 'null' %>;
    const isAdmin = <%= locals.user && locals.user.is_admin ? 'true' : 'false' %>;
    
    let users = []; // Í¥ÄÎ¶¨ÏûêÏö© ÏÇ¨Ïö©Ïûê Î™©Î°ù
    
    // Í¥ÄÎ¶¨ÏûêÏù∏ Í≤ΩÏö∞ ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú
    if (isAdmin) {
        loadUsers();
    }
    
    async function loadUsers() {
        try {
            const response = await fetch('/api/comments/users');
            const data = await response.json();
            
            if (data.success) {
                users = data.users;
                populateUserSelects();
            }
        } catch (error) {
            console.error('ÏÇ¨Ïö©Ïûê Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
        }
    }
    
    function populateUserSelects() {
        const selects = document.querySelectorAll('#comment-author, .edit-author-select');
        selects.forEach(select => {
            // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê ÏòµÏÖò Ï†úÍ±∞ (Ï≤´ Î≤àÏß∏ÏôÄ Íµ¨Î∂ÑÏÑ†ÏùÄ Ïú†ÏßÄ)
            while (select.children.length > 2) {
                select.removeChild(select.lastChild);
            }
            
            // ÏÇ¨Ïö©Ïûê Î™©Î°ù Ï∂îÍ∞Ä
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                select.appendChild(option);
            });
        });
    }
    
    // Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Ïó¥Í∏∞ Ìï®Ïàò
    function openImageModal(imageSrc, imageName) {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('modalImage').alt = imageName;
        document.getElementById('imageModalLabel').textContent = imageName;
        document.getElementById('modalDownloadBtn').href = `/board/download/${postId}`;
        modal.show();
    }
    
    // ÎåìÍ∏Ä ÏûëÏÑ±
    if (isLoggedIn) {
        document.getElementById('comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('comment-content').value;
            const requestData = { post_id: postId, content };
            
            // Í¥ÄÎ¶¨ÏûêÏù∏ Í≤ΩÏö∞ ÏûëÏÑ±Ïûê ÏÑ†ÌÉù Í∞í Ï∂îÍ∞Ä
            if (isAdmin) {
                const customAuthor = document.getElementById('comment-author').value;
                if (customAuthor) {
                    requestData.custom_author = customAuthor;
                }
            }
            
            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ÎåìÍ∏Ä Î™©Î°ùÏóê Ï∂îÍ∞Ä
                    const commentList = document.getElementById('comment-list');
                    const noComments = document.getElementById('no-comments');
                    if (noComments) noComments.remove();
                    
                    const commentHtml = createCommentHtml(data.comment);
                    commentList.insertAdjacentHTML('beforeend', commentHtml);
                    
                    // ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÎåìÍ∏ÄÏùò ÏàòÏ†ï ÌèºÏóêÎèÑ ÏÇ¨Ïö©Ïûê Î™©Î°ù Ï∂îÍ∞Ä
                    if (isAdmin) {
                        populateUserSelects();
                    }
                    
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('comment-content').value = '';
                    if (isAdmin) {
                        document.getElementById('comment-author').value = '';
                    }
                    
                    // ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                    const countEl = document.getElementById('comment-count');
                    countEl.textContent = parseInt(countEl.textContent) + 1;
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ÎåìÍ∏Ä ÏûëÏÑ±Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        });
    }
    
    // ÎåìÍ∏Ä HTML ÏÉùÏÑ± Ìï®Ïàò
    function createCommentHtml(comment) {
        const date = new Date(comment.created_at).toLocaleString();
        const canEdit = currentUserId === comment.user_id || isAdmin;
        const authorName = comment.custom_author || comment.user.username;
        
        let editAuthorSelect = '';
        if (isAdmin) {
            editAuthorSelect = `
                <div class="mb-2">
                    <label class="form-label">ÏûëÏÑ±Ïûê ÏÑ†ÌÉù:</label>
                    <select class="form-select edit-author-select" name="custom_author">
                        <option value="">Î≥∏Ïù∏ Í≥ÑÏ†ï (${comment.user.username})</option>
                        <option value="" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <!-- ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÄ JavaScriptÎ°ú Î°úÎìú -->
                    </select>
                </div>
            `;
        }
        
        return `
            <div class="comment-item border-bottom pb-3 mb-3" data-comment-id="${comment.id}">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${authorName}</strong>
                        <small class="text-muted ms-2">${date}</small>
                    </div>
                    ${canEdit ? `
                        <div>
                            <button class="btn btn-sm btn-link edit-comment" 
                                    data-comment-id="${comment.id}"
                                    data-custom-author="${comment.custom_author || ''}">ÏàòÏ†ï</button>
                            <button class="btn btn-sm btn-link text-danger delete-comment" 
                                    data-comment-id="${comment.id}">ÏÇ≠Ï†ú</button>
                        </div>
                    ` : ''}
                </div>
                <div class="comment-content mt-2">${comment.content}</div>
                <div class="comment-edit-form d-none">
                    ${editAuthorSelect}
                    <textarea class="form-control mb-2" rows="3">${comment.content}</textarea>
                    <div class="text-end">
                        <button class="btn btn-sm btn-secondary cancel-edit">Ï∑®ÏÜå</button>
                        <button class="btn btn-sm btn-primary save-edit" 
                                data-comment-id="${comment.id}">Ï†ÄÏû•</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏùÑ ÏÇ¨Ïö©Ìïú ÎåìÍ∏Ä ÏàòÏ†ï/ÏÇ≠Ï†ú
    document.getElementById('comment-list').addEventListener('click', async (e) => {
        // ÏàòÏ†ï Î≤ÑÌäº ÌÅ¥Î¶≠
        if (e.target.classList.contains('edit-comment')) {
            const commentItem = e.target.closest('.comment-item');
            const customAuthor = e.target.dataset.customAuthor;
            
            commentItem.querySelector('.comment-content').classList.add('d-none');
            commentItem.querySelector('.comment-edit-form').classList.remove('d-none');
            
            // Í¥ÄÎ¶¨ÏûêÏù∏ Í≤ΩÏö∞ ÏûëÏÑ±Ïûê ÏÑ†ÌÉù Í∞í ÏÑ§Ï†ï
            if (isAdmin) {
                const authorSelect = commentItem.querySelector('.edit-author-select');
                if (authorSelect) {
                    authorSelect.value = customAuthor || '';
                }
            }
        }
        
        // ÏàòÏ†ï Ï∑®ÏÜå
        if (e.target.classList.contains('cancel-edit')) {
            const commentItem = e.target.closest('.comment-item');
            commentItem.querySelector('.comment-content').classList.remove('d-none');
            commentItem.querySelector('.comment-edit-form').classList.add('d-none');
        }
        
        // ÏàòÏ†ï Ï†ÄÏû•
        if (e.target.classList.contains('save-edit')) {
            const commentId = e.target.dataset.commentId;
            const commentItem = e.target.closest('.comment-item');
            const content = commentItem.querySelector('textarea').value;
            
            const requestData = { content };
            
            // Í¥ÄÎ¶¨ÏûêÏù∏ Í≤ΩÏö∞ ÏûëÏÑ±Ïûê ÏÑ†ÌÉù Í∞í Ï∂îÍ∞Ä
            if (isAdmin) {
                const authorSelect = commentItem.querySelector('.edit-author-select');
                if (authorSelect) {
                    requestData.custom_author = authorSelect.value;
                }
            }
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ÎåìÍ∏Ä ÎÇ¥Ïö© ÏóÖÎç∞Ïù¥Ìä∏
                    commentItem.querySelector('.comment-content').textContent = content;
                    
                    // ÏûëÏÑ±ÏûêÎ™Ö ÏóÖÎç∞Ïù¥Ìä∏
                    const authorElement = commentItem.querySelector('strong');
                    const newAuthor = requestData.custom_author || data.comment.user?.username || 'Ïïå Ïàò ÏóÜÏùå';
                    authorElement.textContent = newAuthor;
                    
                    // ÏàòÏ†ï Î≤ÑÌäºÏùò Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
                    const editBtn = commentItem.querySelector('.edit-comment');
                    if (editBtn) {
                        editBtn.dataset.customAuthor = requestData.custom_author || '';
                    }
                    
                    commentItem.querySelector('.comment-content').classList.remove('d-none');
                    commentItem.querySelector('.comment-edit-form').classList.add('d-none');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ÎåìÍ∏Ä ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // ÏÇ≠Ï†ú
        if (e.target.classList.contains('delete-comment')) {
            if (!confirm('ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            const commentId = e.target.dataset.commentId;
            
            try {
                const response = await fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    e.target.closest('.comment-item').remove();
                    
                    // ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                    const countEl = document.getElementById('comment-count');
                    countEl.textContent = parseInt(countEl.textContent) - 1;
                    
                    // ÎåìÍ∏ÄÏù¥ ÏóÜÏúºÎ©¥ Î©îÏãúÏßÄ ÌëúÏãú
                    const commentList = document.getElementById('comment-list');
                    if (commentList.children.length === 0) {
                        commentList.innerHTML = '<p class="text-muted text-center" id="no-comments">Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî!</p>';
                    }
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
    });
</script>

<%- include('../partials/footer') %>
